name: 'Set up'
description: 'Set up environment'
inputs:
  fetch-depth:
    description: 'Fetch depth for checkout'
    required: false
  github_token:
    description: 'github_token'
    required: false
outputs:
  LATEST_TAG:
    description: "Latest tag"
    value: ${{ steps.latest_tag.outputs.LATEST_TAG }}
runs:
  using: 'composite'
  steps:
    - name: Setup Node.js environment
      uses: actions/setup-node@v3
      with:
        # https://github.com/facebook/jest/issues/11956
        node-version: '16.10.0'

    - name: Install yarn
      run: corepack enable
      shell: bash

    - name: Checkout
      uses: actions/checkout@v3
      with:
        ref: ${{ inputs.ref }}
        token: ${{ inputs.github_token }}
        fetch-depth: ${{ inputs.fetch-depth }}
        cache_path: |
          **/node_modules
          !**/node_modules/.cache/turbo
          .yarn/cache

    - name: Cache node_modules
      if: inputs.cache == 'true'
      uses: actions/cache@v3
      id: node-modules-cache
      env:
        cache-name: node-modules-yarn
        cache-fingerprint: ${{ env.node-version }}-${{ hashFiles('**/yarn.lock') }}
      with:
        path: ${{ inputs.cache_path }}
        key: v4-${{ runner.os }}-${{ env.cache-name }}-${{ env.cache-fingerprint }}
        restore-keys: v4-${{ runner.os }}-${{ env.cache-name }}-

    - name: Install dependencies
      if: (inputs.cache == 'false' || steps.node-modules-cache.outputs.cache-hit != 'true') && ! inputs.full_install
      run: yarn --immutable
      shell: bash

    - name: Install dependencies FULL
      if: (inputs.cache == 'false' || steps.node-modules-cache.outputs.cache-hit != 'true') && inputs.full_install
      run: yarn --immutable --ignore-optional --production=false
      shell: bash

    - name: set LATEST_TAG
      if: inputs.fetch-depth == '0'
      id: latest_tag
      run: |
          LATEST_TAG=$(git describe --abbrev=0 --tags)
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT
      shell: bash
